<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‹¤ì‹œê°„ ì±„íŒ…</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 250px 1fr 200px;
      gap: 20px;
    }
    #room-list, #user-list {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 5px;
      height: 80vh;
      overflow-y: auto;
    }
    #chat-container {
      display: flex;
      flex-direction: column;
      height: 80vh;
    }
    #chat-box {
      flex: 1;
      border: 1px solid #ddd;
      padding: 15px;
      overflow-y: auto;
      margin-bottom: 10px;
      border-radius: 5px;
    }
    #input-area {
      display: flex;
      gap: 10px;
    }
    #username-input, #message-input {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      flex: 1;
    }
    #send-button, #file-button, #create-room-button {
      padding: 10px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #file-input {
      display: none;
    }
    .room {
      padding: 10px;
      margin: 5px 0;
      cursor: pointer;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
    }
    .room:hover {
      background-color: #f0f0f0;
    }
    .room.active {
      background-color: #4CAF50;
      color: white;
    }
    .message {
      margin-bottom: 15px;
      padding: 10px;
      background-color: #f9f9f9;
      border-radius: 5px;
    }
    .message-info {
      font-size: 0.8em;
      color: #666;
      margin-bottom: 5px;
    }
    .notification {
      color: #888;
      font-style: italic;
    }
    .error-message {
      color: #f44336;
      font-style: italic;
    }
    #room-creation {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }
    #new-room-input {
      flex: 1;
      padding: 8px;
    }
    .user-count {
      font-size: 0.8em;
      color: #666;
    }
    .online-count {
      font-size: 0.9em;
      color: #4CAF50;
      font-weight: bold;
    }
    .user-item {
      padding: 5px 0;
      border-bottom: 1px solid #eee;
    }
    .file-message {
      margin-top: 10px;
    }
    .file-link {
      display: inline-block;
      margin-top: 5px;
      padding: 5px 10px;
      background-color: #f0f0f0;
      border-radius: 4px;
      text-decoration: none;
      color: #333;
    }
    .image-preview {
      max-width: 100%;
      max-height: 200px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div id="room-list">
    <h2>ì±„íŒ…ë°© ëª©ë¡ <span class="online-count" id="online-count">(0ëª… ì˜¨ë¼ì¸)</span></h2>
    <div id="rooms-container">
      <div class="notification">ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
    <div id="room-creation">
      <input type="text" id="new-room-input" placeholder="ìƒˆ ë°© ì´ë¦„">
      <button id="create-room-button">ìƒì„±</button>
    </div>
  </div>

  <div id="chat-container">
    <div id="chat-box">
      <div class="notification">ì±„íŒ…ë°©ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
    </div>
    <div id="input-area">
      <input type="text" id="username-input" placeholder="ì‚¬ìš©ì ì´ë¦„">
      <input type="text" id="message-input" placeholder="ë©”ì‹œì§€ ì…ë ¥" disabled>
      <button id="file-button">ğŸ“</button>
      <input type="file" id="file-input">
      <button id="send-button" disabled>ì „ì†¡</button>
    </div>
  </div>

  <div id="user-list">
    <h2>í˜„ì¬ ì ‘ì†ì <span id="room-user-count">(0ëª…)</span></h2>
    <div id="users-container">
      <div class="notification">ì±„íŒ…ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”</div>
    </div>
  </div>

  <script>
    // DOM ìš”ì†Œ
    const chatBox = document.getElementById('chat-box');
    const usernameInput = document.getElementById('username-input');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const roomsContainer = document.getElementById('rooms-container');
    const newRoomInput = document.getElementById('new-room-input');
    const createRoomButton = document.getElementById('create-room-button');
    const fileInput = document.getElementById('file-input');
    const fileButton = document.getElementById('file-button');
    const onlineCount = document.getElementById('online-count');
    const usersContainer = document.getElementById('users-container');
    const roomUserCount = document.getElementById('room-user-count');

    // ìƒíƒœ ë³€ìˆ˜
    let username = '';
    let currentRoom = null;
    let ws;

    // WebSocket ì—°ê²°
    function connectWebSocket() {
      ws = new WebSocket('ws://localhost:3000');

      ws.onopen = () => {
        console.log('ì„œë²„ì— ì—°ê²°ë¨');
        appendSystemMessage('ì±„íŒ… ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.');
      };

      ws.onmessage = (event) => {
        console.log('ë°›ì€ ë©”ì‹œì§€:', event.data);
        
        try {
          // ë°”ì´ë„ˆë¦¬ ë°ì´í„° ì²˜ë¦¬ (íŒŒì¼ ì „ì†¡)
          if (event.data instanceof Blob) {
            handleFileMessage(event.data);
            return;
          }

          // JSON ë©”ì‹œì§€ ì²˜ë¦¬
          const data = JSON.parse(event.data);
          
          if (data.type === 'roomList') {
            updateRoomList(data.rooms);
            if (data.onlineCount !== undefined) {
              onlineCount.textContent = `(${data.onlineCount}ëª… ì˜¨ë¼ì¸)`;
            }
          }
          else if (data.type === 'userList') {
            updateUserList(data.users);
          }
          else if (data.type === 'registerSuccess') {
            handleRegisterSuccess(data.username);
          }
          else if (data.type === 'roomCreated') {
            handleRoomCreated(data.roomName);
          }
          else if (data.type === 'joinSuccess') {
            handleJoinSuccess(data.room, data.username);
          }
          else if (data.type === 'message') {
            appendMessage(data.username, data.text, data.time);
          }
          else if (data.type === 'file') {
            appendFileMessage(data.username, data.fileName, data.fileUrl, data.time, data.fileType);
          }
          else if (data.type === 'userJoined') {
            appendNotification(`${data.username}ë‹˜ì´ ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤.`);
          }
          else if (data.type === 'userLeft') {
            appendNotification(`${data.username}ë‹˜ì´ ë‚˜ê°”ìŠµë‹ˆë‹¤.`);
          }
          else if (data.type === 'error') {
            appendErrorMessage(data.message);
          }
        } catch (error) {
          console.error('ë©”ì‹œì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
          appendErrorMessage('ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      };

      ws.onclose = () => {
        appendSystemMessage('ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.');
      };

      ws.onerror = (error) => {
        console.error('ì›¹ì†Œì¼“ ì˜¤ë¥˜:', error);
        appendErrorMessage('ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      };
    }

    // ë°© ëª©ë¡ ì—…ë°ì´íŠ¸
    function updateRoomList(rooms) {
      roomsContainer.innerHTML = '';
      
      if (rooms.length === 0) {
        roomsContainer.innerHTML = '<div class="notification">ìƒì„±ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }
      
      rooms.forEach(room => {
        const roomElement = document.createElement('div');
        roomElement.className = `room ${room.name === currentRoom ? 'active' : ''}`;
        roomElement.innerHTML = `
          <span>${room.name}</span>
          <span class="user-count">${room.userCount}ëª…</span>
        `;
        roomElement.addEventListener('click', () => {
          joinRoom(room.name);
        });
        roomsContainer.appendChild(roomElement);
      });
    }

    // ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸
    function updateUserList(userList) {
      usersContainer.innerHTML = '';
      roomUserCount.textContent = `(${userList.length}ëª…)`;
      
      if (userList.length === 0) {
        usersContainer.innerHTML = '<div class="notification">ì ‘ì†ìê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        return;
      }
      
      userList.forEach(username => {
        const userElement = document.createElement('div');
        userElement.className = 'user-item';
        userElement.textContent = username;
        usersContainer.appendChild(userElement);
      });
    }

    // ë°© ì…ì¥
    function joinRoom(roomName) {
      ws.send(JSON.stringify({
        type: 'join',
        room: roomName
      }));
    }

    // ë°© ìƒì„±
    function createRoom() {
      const roomName = newRoomInput.value.trim();
      if (!roomName) {
        appendErrorMessage('ë°© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      ws.send(JSON.stringify({
        type: 'createRoom',
        roomName: roomName
      }));
    }

    // ë©”ì‹œì§€ ì „ì†¡
    function sendMessage() {
      const messageText = messageInput.value.trim();
      
      if (!messageText) return;

      ws.send(JSON.stringify({
        type: 'message',
        text: messageText
      }));
      messageInput.value = '';
    }

    // ì‚¬ìš©ì ë“±ë¡
    function registerUsername() {
      const usernameValue = usernameInput.value.trim();
      if (!usernameValue) {
        appendErrorMessage('ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      
      ws.send(JSON.stringify({
        type: 'register',
        username: usernameValue
      }));
    }

    // íŒŒì¼ ì „ì†¡ ì²˜ë¦¬
    function sendFile(file) {
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function() {
        const fileType = file.type.split('/')[0];
        const fileExt = file.name.split('.').pop();
        
        // ë©”íƒ€ë°ì´í„° ìƒì„±
        const metaData = {
          originalName: file.name,
          ext: fileExt,
          type: fileType
        };
        
        // ë©”íƒ€ë°ì´í„°ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜ (50ë°”ì´íŠ¸ë¡œ ê³ ì •)
        const metaDataStr = JSON.stringify(metaData);
        const metaDataPadded = metaDataStr.padEnd(50, '\0');
        const metaDataBuffer = new TextEncoder().encode(metaDataPadded);
        
        // íŒŒì¼ ë°ì´í„°
        const fileBuffer = new Uint8Array(this.result);
        
        // ë©”íƒ€ë°ì´í„°ì™€ íŒŒì¼ ë°ì´í„° ê²°í•©
        const combinedBuffer = new Uint8Array(metaDataBuffer.length + fileBuffer.length);
        combinedBuffer.set(metaDataBuffer);
        combinedBuffer.set(fileBuffer, metaDataBuffer.length);
        
        // WebSocketìœ¼ë¡œ ì „ì†¡
        ws.send(combinedBuffer);
        appendSystemMessage(`íŒŒì¼ ì „ì†¡ ì¤‘: ${file.name}`);
      };
      reader.readAsArrayBuffer(file);
    }

    // íŒŒì¼ ë©”ì‹œì§€ ì²˜ë¦¬
    function handleFileMessage(blob) {
      const reader = new FileReader();
      reader.onload = function() {
        const arrayBuffer = this.result;
        const metaDataStr = new TextDecoder().decode(new Uint8Array(arrayBuffer.slice(0, 50))).replace(/\0+$/, '');
        const metaData = JSON.parse(metaDataStr);
        
        const fileUrl = URL.createObjectURL(new Blob([arrayBuffer.slice(50)]));
        
        if (metaData.type === 'image') {
          appendMessage(metaData.username, 
            `<div class="file-message">
              <img src="${fileUrl}" class="image-preview">
            </div>`, 
            new Date().toLocaleTimeString());
        } else {
          appendMessage(metaData.username, 
            `<div class="file-message">
              <a href="${fileUrl}" class="file-link" download="${metaData.originalName}">${metaData.originalName} ë‹¤ìš´ë¡œë“œ</a>
            </div>`, 
            new Date().toLocaleTimeString());
        }
      };
      reader.readAsArrayBuffer(blob);
    }

    // ì‚¬ìš©ì ë“±ë¡ ì„±ê³µ ì²˜ë¦¬
    function handleRegisterSuccess(usernameValue) {
      username = usernameValue;
      usernameInput.disabled = true;
      appendSystemMessage(`${username}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤!`);
      messageInput.focus();
    }

    // ë°© ìƒì„± ì„±ê³µ ì²˜ë¦¬
    function handleRoomCreated(roomName) {
      appendSystemMessage(`"${roomName}" ë°©ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      newRoomInput.value = '';
      joinRoom(roomName);
    }

    // ë°© ì…ì¥ ì„±ê³µ ì²˜ë¦¬
    function handleJoinSuccess(room, username) {
      currentRoom = room;
      messageInput.disabled = false;
      sendButton.disabled = false;
      messageInput.focus();
      appendSystemMessage(`"${room}" ë°©ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
    }

    // ë©”ì‹œì§€ í‘œì‹œ
    function appendMessage(username, text, time) {
      const messageElement = document.createElement('div');
      messageElement.className = 'message';
      messageElement.innerHTML = `
        <div class="message-info">${username} (${time})</div>
        <div>${text}</div>
      `;
      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ
    function appendSystemMessage(text) {
      const messageElement = document.createElement('div');
      messageElement.className = 'message notification';
      messageElement.textContent = text;
      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
    function appendErrorMessage(text) {
      const messageElement = document.createElement('div');
      messageElement.className = 'message error-message';
      messageElement.textContent = text;
      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
    function appendNotification(text) {
      const messageElement = document.createElement('div');
      messageElement.className = 'message notification';
      messageElement.textContent = text;
      chatBox.appendChild(messageElement);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
    usernameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') registerUsername();
    });
    createRoomButton.addEventListener('click', createRoom);
    newRoomInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') createRoom();
    });
    fileButton.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      if (fileInput.files.length > 0) {
        sendFile(fileInput.files[0]);
        fileInput.value = '';
      }
    });

    // ì´ˆê¸°í™”
    connectWebSocket();
  </script>
</body>
</html>
