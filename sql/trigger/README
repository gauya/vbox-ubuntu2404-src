/* postgresql trigger 

*/


-- ì–¸ì–´ ì„¤ì¹˜
CREATE EXTENSION IF NOT EXISTS plpythonu;

-- ì˜ˆì œ í…Œì´ë¸”
CREATE TABLE dfn (
    name TEXT PRIMARY KEY,
    path VARCHAR(120) NOT NULL unique
);


----------------------------------------------------------

1. í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ì„œ ì‚­ì œ, íŒ¨ìŠ¤ëŠ” ì ˆëŒ€ê²½ë¡œë§Œ ì‚¬ìš© 

CREATE OR REPLACE FUNCTION delete_file_entry(nm TEXT)
RETURNS VOID AS $$
    import os

    # ì»¤ì„œ ê°€ì ¸ì˜¤ê¸°
    plpy.execute("BEGIN")
    result = plpy.execute("SELECT path FROM dfn WHERE name = %s", [nm])

    if not result:
        plpy.error("íŒŒì¼ ë³„ëª… '{}'ì„(ë¥¼) ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.".format(nm))

    path = result[0]["path"]

    # íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    if not os.path.exists(path):
        plpy.error("íŒŒì¼ '{}' ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.".format(path))

    try:
        os.remove(path)
    except Exception as e:
        plpy.error("íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: " + str(e))

    plpy.execute("DELETE FROM dfn WHERE name = %s", [nm])
    plpy.execute("COMMIT")
$$ LANGUAGE plpythonu;

///////////////////
INSERT INTO dfn VALUES ('foo', '/tmp/testfile.mp3');

SELECT delete_file_entry('foo'); -- o/sìƒì˜ íŒŒì¼ê³¼ DBì†ì˜ ë°ì´íƒ€ ì‚­ì œ


2. íŠ¸ë¦¬ê±°ì‚¬ìš©ìœ¼ë¡œ ìë™ì‚­ì œ

CREATE OR REPLACE FUNCTION dfn_file_delete_trigger()
RETURNS trigger AS $$
    import os

    path = TD["old"]["path"]
    name = TD["old"]["name"]

    if not os.path.exists(path):
        plpy.error(f"[ì‚­ì œ ì¤‘ë‹¨] íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ: {path}")

    try:
        os.remove(path)
        plpy.info(f"[ì‚­ì œ ì„±ê³µ] íŒŒì¼: {path}")
    except Exception as e:
        plpy.error(f"[ì‚­ì œ ì‹¤íŒ¨] {e}")

    return TD["old"]
$$ LANGUAGE plpythonu;

DROP TRIGGER IF EXISTS trg_dfn_delete ON dfn;

CREATE TRIGGER trg_dfn_delete
BEFORE DELETE ON dfn
FOR EACH ROW
EXECUTE FUNCTION dfn_file_delete_trigger();

//////////////////////////////////////

DELETE FROM dfn WHERE name = 'foo';  -- DBë°ì´íƒ€ë¥¼ ì‚­ì œí•˜ë©´ íŒŒì¼ë„ ìë™ì‚­ì œ


3. notifyë¡œ ì‹ í˜¸ë¥¼ ë³´ë‚´ê³  ì™¸ë¶€ì˜ ë°ëª¬ì´ ì´ë¥¼ ë°›ì•„ì²˜ë¦¬

CREATE OR REPLACE FUNCTION notify_file_delete()
RETURNS trigger AS $$
DECLARE
    payload JSON;
BEGIN
    payload := json_build_object(
        'name', OLD.name,
        'path', OLD.path
    );

    PERFORM pg_notify('file_delete', payload::text);
    RETURN OLD;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_notify_delete
AFTER DELETE ON dfn
FOR EACH ROW
EXECUTE FUNCTION notify_file_delete();

/////////////////////////////////
pip install psycopg2-binary

# file_watcher.py
import psycopg2, select, json, os

conn = psycopg2.connect("dbname=YOUR_DB user=YOUR_USER")
conn.set_isolation_level(psycopg2.extensions.ISOLATION_LEVEL_AUTOCOMMIT)

cur = conn.cursor()
cur.execute("LISTEN file_delete;")
print("ğŸ”„ íŒŒì¼ ì‚­ì œ ê°ì‹œ ì¤‘ (ì±„ë„: file_delete)...")

while True:
    if select.select([conn], [], [], 5) == ([], [], []):
        continue  # timeout
    conn.poll()
    while conn.notifies:
        notify = conn.notifies.pop(0)
        data = json.loads(notify.payload)
        path = data["path"]
        print(f"ğŸ“£ ì‚­ì œ ìš”ì²­: {path}")
        try:
            os.remove(path)
            print(f"âœ… ì‚­ì œ ì™„ë£Œ: {path}")
        except Exception as e:
            print(f"âŒ ì‚­ì œ ì‹¤íŒ¨: {e}")

            
/////// ë°ëª¬ ì¤€ë¹„
sudo mkdir -p /opt/file-watcher
sudo cp file_watcher.py /opt/file-watcher/
sudo chmod +x /opt/file-watcher/file_watcher.py

sudo vi /etc/systemd/system/file-watcher.service

==============================
[Unit]
Description=PostgreSQL File Deletion Listener
After=network.target postgresql.service

[Service]
ExecStart=/usr/bin/python /opt/file-watcher/file_watcher.py
Restart=on-failure
User=postgres
WorkingDirectory=/opt/file-watcher
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
=============================

// ë°ëª¬ë“±ë¡
sudo systemctl daemon-reexec
sudo systemctl daemon-reload

sudo systemctl enable file-watcher.service
sudo systemctl start file-watcher.service

// ìƒíƒœí™•ì¸
sudo systemctl status file-watcher.service

// ë¡œê·¸í™•ì¸
journalctl -u file-watcher.service -f
//////////////////////////////////////////////////

INSERT INTO dfn VALUES ('abc', '/tmp/test.mp3');
DELETE FROM dfn WHERE name = 'abc';  -- íŒŒì´ì¬ë°ëª¬ì´ ìë™ìœ¼ë¡œ íŒŒì¼ì‚­ì œ


===============================================

/opt/file-watcher/.env # .env íŒŒì¼ì˜ ëª¨ë“œëŠ” 600 ë˜ëŠ”640
DB_NAME=yourdbname
DB_USER=youruser
DB_PASSWORD=yourpassword
DB_HOST=localhost
DB_PORT=5432
-------------------------------

# /etc/systemd/system/file-watcher.service ì— ì¶”ê°€

[Service]
EnvironmentFile=/opt/file-watcher/.env    


